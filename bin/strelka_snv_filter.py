#!/usr/bin/env python

import gzip
import argparse
import sys

def parse_args(args=None):
    Description = "Filter and reformat snvs vcf generated by Strelka."
    Epilog = "Example usage: python check_samplesheet.py <FILE_IN> <FILE_OUT>"

    parser = argparse.ArgumentParser(description=Description, epilog=Epilog)
    parser.add_argument("FILE_IN", help="Input vcf file.")
    parser.add_argument("FILE_OUT", help="Output filtered vcf file.")
    return parser.parse_args(args)

def index_column_substring(your_list, substring):
    for i, s in enumerate(your_list):
        if substring in s:
            return i
    return -1

def strelka2_filter(input, output):
    """
    Filters a Strelka2 VCF file (SNPs) to add the genotype field info
    and keep variants that PASS
    :param input: the input VCF generated with Strelka2
    :param output: the name of filtered VCF file
    :return: None
    """
    filtered_vcf = open(output, 'w')
    vcf = gzip.open(input, 'rt')
    for line in vcf:
        if '##FORMAT=<ID=DP,' in line:
            filtered_vcf.write('##FORMAT=<ID=GT,Number=1,Type=String,Description="Genotype">\n' + line)
        elif line.startswith('#CHROM'):
            headers = line.strip().split('\t')
            filtered_vcf.write(line)
        elif not line.startswith('#'):
            columns = line.strip().split('\t')
            ref = columns[headers.index('REF')]
            if 'PASS' not in columns[headers.index('FILTER')]:
                continue
            INFO = columns[headers.index('INFO')]
            Format = columns[headers.index('FORMAT')]
            Tumor = columns[headers.index('TUMOR')]
            Normal = columns[headers.index('NORMAL')]
            Format = 'GT:' + Format
            INFO_split = INFO.split(';')
            SGT = INFO_split[6].replace('SGT=', '').split('->')
            Normal_GT = ''
            Tumor_GT = ''
            i = 1
            for x in SGT[0]:
                if x == ref and i == 1:
                    Normal_GT += '0'
                    i = i + 1
                elif x == ref and i == 2:
                    Normal_GT += '/0'
                    i = i + 1
                elif x != ref and i == 1:
                    Normal_GT += '1'
                    i = i + 1
                elif x != ref and i == 2:
                    Normal_GT += '/1'
                    i = i + 1
            i = 1
            for x in SGT[1]:
                if x == ref and i == 1:
                    Tumor_GT += '0'
                    i = i + 1
                elif x == ref and i == 2:
                    Tumor_GT += '/0'
                    i = i + 1
                elif x != ref and i == 1:
                    Tumor_GT += '1'
                    i = i + 1
                elif x != ref and i == 2:
                    Tumor_GT += '/1'
                    i = i + 1
            filtered_vcf.write('{}\t{}\t{}:{}\t{}:{}\n'.format('\t'.join(columns[0:8]),
                                                               Format,
                                                               Normal_GT,
                                                               Normal,
                                                               Tumor_GT,
                                                               Tumor))
        else:
            filtered_vcf.write(line)
    vcf.close()
    filtered_vcf.close()

def main(args=None):
    args = parse_args(args)
    strelka2_filter(args.FILE_IN, args.FILE_OUT)

if __name__ == "__main__":
    sys.exit(main())
